{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "vibe-science-v5.0/stage5-exit",
  "title": "Stage 5 Exit Gate Artifact (S5)",
  "description": "Final gate artifact for Stage 5 — Synthesis & Review Exit. Structurally enforces the S5 POISON PILL: the DISPUTED status is excluded from the final_status enum, meaning this schema CANNOT validate if any claim remains disputed. All disputes must be resolved (new data, claim dropped, or human override) before S5 can close. R2 ensemble verdict must be ACCEPT — no WEAK_ACCEPT, no REJECT.",
  "type": "object",
  "required": [
    "rq_id",
    "stage",
    "r2_ensemble_verdict",
    "d2_gate_reference",
    "all_claims",
    "disputed_claims_resolved",
    "tree_final_snapshot",
    "knowledge_base_updated",
    "all_artifacts_crystallized",
    "completed_at"
  ],
  "additionalProperties": false,
  "properties": {
    "rq_id": {
      "type": "string",
      "description": "Research question identifier (e.g., RQ-001). Links this gate artifact to the research question being concluded.",
      "pattern": "^RQ-\\d{3,}$"
    },
    "stage": {
      "const": 5,
      "description": "Stage number. Must be 5 for this gate artifact."
    },
    "r2_ensemble_verdict": {
      "type": "object",
      "description": "Reviewer 2 ensemble final verdict. Only ACCEPT is permitted at S5 — the system must not close with WEAK_ACCEPT or REJECT. This is a hard structural constraint, not a soft recommendation.",
      "required": [
        "verdict",
        "report_id",
        "reviewed_at"
      ],
      "additionalProperties": false,
      "properties": {
        "verdict": {
          "const": "ACCEPT",
          "description": "R2 ensemble verdict. Structurally locked to ACCEPT — S5 cannot close with any other verdict. If R2 has not reached ACCEPT, the gate cannot produce a valid artifact."
        },
        "report_id": {
          "type": "string",
          "description": "Identifier of the R2 ensemble review report (e.g., R2-RPT-20260215-001).",
          "minLength": 1
        },
        "reviewed_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of when R2 ensemble review was finalized."
        }
      }
    },
    "d2_gate_reference": {
      "type": "string",
      "description": "File path or identifier of the D2 (RQ Conclusion) gate artifact. S5 requires D2 to have passed. This links to the evidence that D2 criteria were satisfied.",
      "minLength": 1
    },
    "all_claims": {
      "type": "array",
      "description": "Complete list of all claims with their final resolved status. Every claim ever registered in the CLAIM-LEDGER must appear here. DISPUTED is structurally excluded from final_status — this is the S5 POISON PILL enforcement.",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": [
          "claim_id",
          "final_status",
          "confidence_score"
        ],
        "additionalProperties": false,
        "properties": {
          "claim_id": {
            "type": "string",
            "description": "Unique claim identifier from the CLAIM-LEDGER (e.g., C-001).",
            "pattern": "^C-\\d{3,}$"
          },
          "final_status": {
            "type": "string",
            "enum": [
              "VERIFIED",
              "CONFIRMED",
              "ROBUST",
              "REJECTED",
              "KILLED"
            ],
            "description": "Final resolved status of the claim. DISPUTED is intentionally excluded from this enum — this is the structural enforcement of the S5 POISON PILL (Circuit Breaker Enhancement E). If any claim is still DISPUTED, it cannot appear in a valid S5 artifact, which means the gate cannot close. Resolution options: (1) new data resolves the dispute → status becomes VERIFIED/CONFIRMED/ROBUST, (2) claim is dropped from conclusion → status becomes REJECTED/KILLED, (3) human override with documented rationale → status becomes one of the permitted values."
          },
          "confidence_score": {
            "description": "Final computed confidence score (0.0 to 1.0). Must be null for REJECTED or KILLED claims — a dead claim has no confidence. Must be a number in [0, 1] for VERIFIED, CONFIRMED, or ROBUST claims.",
            "oneOf": [
              {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              {
                "type": "null"
              }
            ]
          }
        },
        "if": {
          "properties": {
            "final_status": {
              "enum": ["REJECTED", "KILLED"]
            }
          }
        },
        "then": {
          "properties": {
            "confidence_score": {
              "type": "null"
            }
          }
        },
        "else": {
          "properties": {
            "confidence_score": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        }
      }
    },
    "disputed_claims_resolved": {
      "const": true,
      "description": "S5 POISON PILL (Circuit Breaker Enhancement E). This field must be true — it is structurally locked. Its presence as a required const:true field means no S5 artifact can be produced while any claim remains DISPUTED. If DISPUTED claims exist at S5, the gate MUST fail with specific resolution options: (1) new data resolves the dispute, (2) claim is dropped from conclusion, (3) human override with documented rationale."
    },
    "tree_final_snapshot": {
      "type": "string",
      "description": "File path to the final tree visualization snapshot (e.g., .vibe-science/tree-final-RQ-001.png or .vibe-science/TREE-STATE.json). This captures the complete exploration tree at conclusion.",
      "minLength": 1
    },
    "knowledge_base_updated": {
      "const": true,
      "description": "Confirms that the knowledge base has been updated with all findings, decisions, and lessons learned from this research question. Structurally locked to true — S5 cannot close without this."
    },
    "all_artifacts_crystallized": {
      "const": true,
      "description": "Confirms that all results, decisions, pivots, and kills have been written to persistent files (LAW 10: CRYSTALLIZE OR LOSE). Structurally locked to true — S5 cannot close without this."
    },
    "completed_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of when Stage 5 was completed and the RQ was formally concluded."
    }
  }
}
